{% extends "base.html" %}
{% block content %}
<h2>Encontre Instituições Próximas</h2>
<form method="POST">
    <label>Seu endereço:
        <input type="text" name="endereco" required placeholder="Ex: Av. Paulista, 1000, São Paulo">
    </label>
    <button type="submit">Buscar</button>
</form>

{% if instituicoes and user_lat %}
<div id="map" style="height: 400px; margin: 20px 0; border: 1px solid #ccc;"></div>
<h3>Resultados:</h3>
<ul>
{% for inst in instituicoes %}
    <li>
        <strong>{{ inst.nome }}</strong><br>
        📍 {{ inst.endereco }}<br>
        📞 {{ inst.telefone or 'Não informado' }}<br>
        💻 <a href="{{ inst.url_doacao }}" target="_blank">Página de Doação</a><br>
        {% if inst.distancia_km %}
            📏 {{ inst.distancia_km }} km de você
        {% endif %}
    </li>
</ul>
{% elif request.method == 'POST' %}
<p>Nenhuma instituição encontrada.</p>
{% endif %}
{% endblock %}

{% block scripts %}
{% if user_lat and user_lon %}
<script>
    var map = L.map('map').setView([{{ user_lat }}, {{ user_lon }}], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    L.marker([{{ user_lat }}, {{ user_lon }}]).addTo(map)
        .bindPopup('Sua localização').openPopup();

    {% for inst in instituicoes %}
        {% if inst.latitude and inst.longitude %}
            L.marker([{{ inst.latitude }}, {{ inst.longitude }}]).addTo(map)
                .bindPopup("<b>{{ inst.nome|e }}</b><br>{{ inst.distancia_km }} km");
        {% endif %}
    {% endfor %}
</script>
{% endif %}
{% endblock %}